{% extends "admin/base.html" %}

{% block page_title %}é¢„æµ‹è®°å½•ç®¡ç†{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ğŸ¯ ç®¡ç†é¢„æµ‹è®°å½•</h2>
        <div style="display: flex; gap: 1rem;">
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelected()">
                åˆ é™¤é€‰ä¸­
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="clearAll()">
                æ¸…ç©ºæ‰€æœ‰
            </button>
        </div>
    </div>
    
    <form id="batchDeleteForm" method="POST" action="{{ url_for('admin.delete_predictions_batch') }}">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleAll()">
                        </th>
                        <th>ç”¨æˆ·</th>
                        <th>åœ°åŒº</th>
                        <th>ç­–ç•¥</th>
                        <th>æœŸæ•°</th>
                        <th>å¹³ç </th>
                        <th>ç‰¹ç </th>
                        <th>ç”Ÿè‚–</th>
                        <th>å‡†ç¡®ç‡</th>
                        <th>é¢„æµ‹æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% if predictions.items %}
                        {% for prediction in predictions.items %}
                        <tr>
                            <td>
                                <input type="checkbox" name="prediction_ids" value="{{ prediction.id }}" class="prediction-checkbox">
                            </td>
                            <td>{{ prediction.username if prediction.username else 'æœªçŸ¥ç”¨æˆ·' }}</td>
                            <td>
                                {% if prediction.region == 'hk' %}
                                    <span class="badge badge-primary">é¦™æ¸¯</span>
                                {% elif prediction.region == 'macau' %}
                                    <span class="badge badge-secondary">æ¾³é—¨</span>
                                {% else %}
                                    {{ prediction.region }}
                                {% endif %}
                            </td>
                            <td>
                                {% if prediction.strategy == 'ai' %}
                                    <span class="badge badge-primary">AIé¢„æµ‹</span>
                                {% elif prediction.strategy == 'balanced' %}
                                    <span class="badge badge-success">å‡è¡¡é¢„æµ‹</span>
                                {% elif prediction.strategy == 'random' %}
                                    <span class="badge badge-secondary">éšæœºé¢„æµ‹</span>
                                {% else %}
                                    {{ prediction.strategy }}
                                {% endif %}
                            </td>
                            <td>{{ prediction.period }}</td>
                            <td>
                                <div style="display: flex; gap: 3px; flex-wrap: wrap; justify-content: center;">
                                    {% if prediction.normal_numbers %}
                                        {% for num in prediction.normal_numbers.split(',') %}
                                            <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.8rem; min-width: 24px; text-align: center;">{{ num }}</span>
                                        {% endfor %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if prediction.special_number %}
                                    <span style="background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 50%; font-weight: bold; border: 2px solid #ffd700;">{{ prediction.special_number }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ prediction.special_zodiac or '-' }}</td>
                            <td>
                                {% if prediction.accuracy_score is not none %}
                                    {% set accuracy = (prediction.accuracy_score * 100) | round(1) %}
                                    {% if accuracy >= 70 %}
                                        <span style="color: #28a745; font-weight: bold;">{{ accuracy }}%</span>
                                    {% elif accuracy >= 40 %}
                                        <span style="color: #ffc107; font-weight: bold;">{{ accuracy }}%</span>
                                    {% else %}
                                        <span style="color: #dc3545; font-weight: bold;">{{ accuracy }}%</span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #666;">å¾…å¼€å¥–</span>
                                {% endif %}
                            </td>
                            <td>{{ prediction.created_at.strftime('%Y-%m-%d %H:%M') if prediction.created_at else '-' }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('admin.delete_prediction', prediction_id=prediction.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é¢„æµ‹è®°å½•å—ï¼Ÿ')">
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        åˆ é™¤
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="11" style="text-align: center; padding: 3rem; color: #666;">
                                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">ğŸ¯</div>
                                <p>æš‚æ— é¢„æµ‹è®°å½•</p>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">ç”¨æˆ·è¿›è¡Œé¢„æµ‹åå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </form>

    <!-- åˆ†é¡µ -->
    {% if predictions.pages > 1 %}
    <div class="pagination">
        {% if predictions.has_prev %}
            <a href="{{ url_for('admin.predictions', page=predictions.prev_num) }}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        
        {% for page_num in predictions.iter_pages() %}
            {% if page_num %}
                {% if page_num != predictions.page %}
                    <a href="{{ url_for('admin.predictions', page=page_num) }}">{{ page_num }}</a>
                {% else %}
                    <span class="active">{{ page_num }}</span>
                {% endif %}
            {% else %}
                <span>â€¦</span>
            {% endif %}
        {% endfor %}
        
        {% if predictions.has_next %}
            <a href="{{ url_for('admin.predictions', page=predictions.next_num) }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function toggleAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.prediction-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.prediction-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„é¢„æµ‹è®°å½•');
        return;
    }
    
    if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} æ¡é¢„æµ‹è®°å½•å—ï¼Ÿ`)) {
        document.getElementById('batchDeleteForm').submit();
    }
}

function clearAll() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é¢„æµ‹è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin.clear_all_predictions") }}';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}