{% extends "admin/base.html" %}

{% block page_title %}预测记录管理{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">🎯 管理预测记录</h2>
        <div style="display: flex; gap: 1rem;">
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelected()">
                删除选中
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="clearAll()">
                清空所有
            </button>
        </div>
    </div>
    
    <form id="batchDeleteForm" method="POST" action="{{ url_for('admin.delete_predictions_batch') }}">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleAll()">
                        </th>
                        <th>用户</th>
                        <th>地区</th>
                        <th>策略</th>
                        <th>期数</th>
                        <th>平码</th>
                        <th>特码</th>
                        <th>生肖</th>
                        <th>准确率</th>
                        <th>预测时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% if predictions.items %}
                        {% for prediction in predictions.items %}
                        <tr>
                            <td>
                                <input type="checkbox" name="prediction_ids" value="{{ prediction.id }}" class="prediction-checkbox">
                            </td>
                            <td>{{ prediction.username if prediction.username else '未知用户' }}</td>
                            <td>
                                {% if prediction.region == 'hk' %}
                                    <span class="badge badge-primary">香港</span>
                                {% elif prediction.region == 'macau' %}
                                    <span class="badge badge-secondary">澳门</span>
                                {% else %}
                                    {{ prediction.region }}
                                {% endif %}
                            </td>
                            <td>
                                {% if prediction.strategy == 'ai' %}
                                    <span class="badge badge-primary">AI预测</span>
                                {% elif prediction.strategy == 'balanced' %}
                                    <span class="badge badge-success">均衡预测</span>
                                {% elif prediction.strategy == 'random' %}
                                    <span class="badge badge-secondary">随机预测</span>
                                {% else %}
                                    {{ prediction.strategy }}
                                {% endif %}
                            </td>
                            <td>{{ prediction.period }}</td>
                            <td>
                                <div style="display: flex; gap: 3px; flex-wrap: wrap; justify-content: center;">
                                    {% if prediction.normal_numbers %}
                                        {% for num in prediction.normal_numbers.split(',') %}
                                            <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.8rem; min-width: 24px; text-align: center;">{{ num }}</span>
                                        {% endfor %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if prediction.special_number %}
                                    <span style="background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 50%; font-weight: bold; border: 2px solid #ffd700;">{{ prediction.special_number }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ prediction.special_zodiac or '-' }}</td>
                            <td>
                                {% if prediction.accuracy_score is not none %}
                                    {% set accuracy = (prediction.accuracy_score * 100) | round(1) %}
                                    {% if accuracy >= 70 %}
                                        <span style="color: #28a745; font-weight: bold;">{{ accuracy }}%</span>
                                    {% elif accuracy >= 40 %}
                                        <span style="color: #ffc107; font-weight: bold;">{{ accuracy }}%</span>
                                    {% else %}
                                        <span style="color: #dc3545; font-weight: bold;">{{ accuracy }}%</span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #666;">待开奖</span>
                                {% endif %}
                            </td>
                            <td>{{ prediction.created_at.strftime('%Y-%m-%d %H:%M') if prediction.created_at else '-' }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('admin.delete_prediction', prediction_id=prediction.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('确定要删除这条预测记录吗？')">
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        删除
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="11" style="text-align: center; padding: 3rem; color: #666;">
                                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">🎯</div>
                                <p>暂无预测记录</p>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">用户进行预测后将在这里显示</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </form>

    <!-- 分页 -->
    {% if predictions.pages > 1 %}
    <div class="pagination">
        {% if predictions.has_prev %}
            <a href="{{ url_for('admin.predictions', page=predictions.prev_num) }}">上一页</a>
        {% endif %}
        
        {% for page_num in predictions.iter_pages() %}
            {% if page_num %}
                {% if page_num != predictions.page %}
                    <a href="{{ url_for('admin.predictions', page=page_num) }}">{{ page_num }}</a>
                {% else %}
                    <span class="active">{{ page_num }}</span>
                {% endif %}
            {% else %}
                <span>…</span>
            {% endif %}
        {% endfor %}
        
        {% if predictions.has_next %}
            <a href="{{ url_for('admin.predictions', page=predictions.next_num) }}">下一页</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function toggleAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.prediction-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.prediction-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('请选择要删除的预测记录');
        return;
    }
    
    if (confirm(`确定要删除选中的 ${checkboxes.length} 条预测记录吗？`)) {
        document.getElementById('batchDeleteForm').submit();
    }
}

function clearAll() {
    if (confirm('确定要清空所有预测记录吗？此操作不可恢复！')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin.clear_all_predictions") }}';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}