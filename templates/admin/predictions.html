{% extends "admin/base.html" %}

{% block page_title %}é¢„æµ‹è®°å½•ç®¡ç†{% endblock %}

{% block content %}
<style>
    /* å·ç çƒæ ·å¼ */
    .number-ball {
        display: inline-block;
        width: 28px;
        height: 28px;
        line-height: 28px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        text-align: center;
        font-size: 0.85rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: transform 0.2s ease;
    }
    
    .number-ball:hover {
        transform: scale(1.15);
    }
    
    .red-ball {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%);
    }
    
    .blue-ball {
        background: linear-gradient(135deg, #54a0ff 0%, #2e86de 100%);
    }
    
    .green-ball {
        background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%);
    }
    
    /* ç‰¹ç çƒæ ·å¼ */
    .special-ball {
        display: inline-block;
        width: 36px;
        height: 36px;
        line-height: 32px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        text-align: center;
        font-size: 1rem;
        box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        border: 2px solid #ffd700;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .special-ball:hover {
        transform: scale(1.15);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .red-special {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%);
    }
    
    .blue-special {
        background: linear-gradient(135deg, #54a0ff 0%, #2e86de 100%);
    }
    
    .green-special {
        background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%);
    }
    
    /* ç”Ÿè‚–æ ‡ç­¾æ ·å¼ */
    .zodiac-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        color: white;
        font-weight: 500;
        font-size: 0.9rem;
        box-shadow: 0 2px 5px rgba(108, 92, 231, 0.3);
    }
    
    /* å‡†ç¡®ç‡æ ·å¼ */
    .accuracy {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .high-accuracy {
        background-color: rgba(40, 167, 69, 0.15);
        color: #28a745;
    }
    
    .medium-accuracy {
        background-color: rgba(255, 193, 7, 0.15);
        color: #d39e00;
    }
    
    .low-accuracy {
        background-color: rgba(220, 53, 69, 0.15);
        color: #dc3545;
    }
    
    .pending-result {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        background-color: rgba(108, 117, 125, 0.15);
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    /* æ—¶é—´æ ‡ç­¾æ ·å¼ */
    .time-badge {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .time-icon {
        font-size: 1rem;
    }
    
    /* æ“ä½œæŒ‰é’®æ ·å¼ */
    .action-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
    }
    
    .delete-icon {
        font-size: 1rem;
    }
    
    /* æ— æ•°æ®æ ·å¼ */
    .no-data {
        color: #aaa;
        font-style: italic;
    }
    
    /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
    .table th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .table tr:nth-child(even) {
        background-color: rgba(0,0,0,0.02);
    }
    
    .table tr:hover {
        background-color: rgba(102, 126, 234, 0.05);
    }
</style>
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ğŸ¯ ç®¡ç†é¢„æµ‹è®°å½•</h2>
        <div style="display: flex; gap: 1rem;">
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelected()">
                åˆ é™¤é€‰ä¸­
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="clearAll()">
                æ¸…ç©ºæ‰€æœ‰
            </button>
        </div>
    </div>
    
    <form id="batchDeleteForm" method="POST" action="{{ url_for('admin.delete_predictions_batch') }}">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleAll()">
                        </th>
                        <th>ç”¨æˆ·</th>
                        <th>åœ°åŒº</th>
                        <th>ç­–ç•¥</th>
                        <th>æœŸæ•°</th>
                        <th>å¹³ç </th>
                        <th>ç‰¹ç </th>
                        <th>ç”Ÿè‚–</th>
                        <th>å‡†ç¡®ç‡</th>
                        <th>é¢„æµ‹æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% if predictions.items %}
                        {% for prediction in predictions.items %}
                        <tr>
                            <td>
                                <input type="checkbox" name="prediction_ids" value="{{ prediction.id }}" class="prediction-checkbox">
                            </td>
                            <td>{{ prediction.username if prediction.username else 'æœªçŸ¥ç”¨æˆ·' }}</td>
                            <td>
                                {% if prediction.region == 'hk' %}
                                    <span class="badge badge-primary">é¦™æ¸¯</span>
                                {% elif prediction.region == 'macau' %}
                                    <span class="badge badge-secondary">æ¾³é—¨</span>
                                {% else %}
                                    {{ prediction.region }}
                                {% endif %}
                            </td>
                            <td>
                                {% if prediction.strategy == 'ai' %}
                                    <span class="badge badge-primary">AIé¢„æµ‹</span>
                                {% elif prediction.strategy == 'balanced' %}
                                    <span class="badge badge-success">å‡è¡¡é¢„æµ‹</span>
                                {% elif prediction.strategy == 'random' %}
                                    <span class="badge badge-secondary">éšæœºé¢„æµ‹</span>
                                {% else %}
                                    {{ prediction.strategy }}
                                {% endif %}
                            </td>
                            <td>{{ prediction.period }}</td>
                            <td>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
                                    {% if prediction.normal_numbers %}
                                        {% for num in prediction.normal_numbers.split(',') %}
                                            {% set num_int = num|int %}
                                            {% if num_int in [1, 2, 7, 8, 12, 13, 18, 19, 23, 24, 29, 30, 34, 35, 40, 45, 46] %}
                                                <span class="number-ball red-ball">{{ num }}</span>
                                            {% elif num_int in [3, 4, 9, 10, 14, 15, 20, 25, 26, 31, 36, 37, 41, 42, 47, 48] %}
                                                <span class="number-ball blue-ball">{{ num }}</span>
                                            {% else %}
                                                <span class="number-ball green-ball">{{ num }}</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="no-data">-</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if prediction.special_number %}
                                    {% set special_num = prediction.special_number|int %}
                                    {% if special_num in [1, 2, 7, 8, 12, 13, 18, 19, 23, 24, 29, 30, 34, 35, 40, 45, 46] %}
                                        <span class="special-ball red-special">{{ prediction.special_number }}</span>
                                    {% elif special_num in [3, 4, 9, 10, 14, 15, 20, 25, 26, 31, 36, 37, 41, 42, 47, 48] %}
                                        <span class="special-ball blue-special">{{ prediction.special_number }}</span>
                                    {% else %}
                                        <span class="special-ball green-special">{{ prediction.special_number }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="no-data">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if prediction.special_zodiac %}
                                    <span class="zodiac-badge">{{ prediction.special_zodiac }}</span>
                                {% else %}
                                    <span class="no-data">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if prediction.accuracy_score is not none %}
                                    {% set accuracy = (prediction.accuracy_score * 100) | round(1) %}
                                    {% if accuracy >= 70 %}
                                        <span class="accuracy high-accuracy">{{ accuracy }}%</span>
                                    {% elif accuracy >= 40 %}
                                        <span class="accuracy medium-accuracy">{{ accuracy }}%</span>
                                    {% else %}
                                        <span class="accuracy low-accuracy">{{ accuracy }}%</span>
                                    {% endif %}
                                {% else %}
                                    <span class="pending-result">å¾…å¼€å¥–</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="time-badge">
                                    <i class="time-icon">ğŸ•’</i>
                                    {{ prediction.created_at.strftime('%Y-%m-%d %H:%M') if prediction.created_at else '-' }}
                                </span>
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('admin.delete_prediction', prediction_id=prediction.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é¢„æµ‹è®°å½•å—ï¼Ÿ')">
                                    <button type="submit" class="btn btn-danger btn-sm action-btn">
                                        <i class="delete-icon">ğŸ—‘ï¸</i> åˆ é™¤
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="11" style="text-align: center; padding: 3rem; color: #666;">
                                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">ğŸ¯</div>
                                <p>æš‚æ— é¢„æµ‹è®°å½•</p>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">ç”¨æˆ·è¿›è¡Œé¢„æµ‹åå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </form>

    <!-- åˆ†é¡µ -->
    {% if predictions.pages > 1 %}
    <div class="pagination">
        {% if predictions.has_prev %}
            <a href="{{ url_for('admin.predictions', page=predictions.prev_num) }}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        
        {% for page_num in predictions.iter_pages() %}
            {% if page_num %}
                {% if page_num != predictions.page %}
                    <a href="{{ url_for('admin.predictions', page=page_num) }}">{{ page_num }}</a>
                {% else %}
                    <span class="active">{{ page_num }}</span>
                {% endif %}
            {% else %}
                <span>â€¦</span>
            {% endif %}
        {% endfor %}
        
        {% if predictions.has_next %}
            <a href="{{ url_for('admin.predictions', page=predictions.next_num) }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function toggleAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.prediction-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.prediction-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„é¢„æµ‹è®°å½•');
        return;
    }
    
    if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} æ¡é¢„æµ‹è®°å½•å—ï¼Ÿ`)) {
        document.getElementById('batchDeleteForm').submit();
    }
}

function clearAll() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é¢„æµ‹è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin.clear_all_predictions") }}';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}