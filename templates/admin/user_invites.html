{% extends "admin/base.html" %}

{% block page_title %}é‚€è¯·å…³ç³»ç®¡ç†{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ğŸ¤ æŸ¥çœ‹é‚€è¯·å…³ç³»</h2>
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem;">
        <div class="stat-card">
            <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem; color: #667eea;">ğŸ«</div>
            <div class="stat-number">{{ invited_users.total if invited_users else 0 }}</div>
            <div class="stat-label">æ€»é‚€è¯·æ•°</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem; color: #28a745;">âœ…</div>
            <div class="stat-number">{{ invite_stats.values() | sum if invite_stats else 0 }}</div>
            <div class="stat-label">æˆåŠŸé‚€è¯·</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem; color: #17a2b8;">ğŸ‘¥</div>
            <div class="stat-number">{{ invite_stats.keys() | length if invite_stats else 0 }}</div>
            <div class="stat-label">æ´»è·ƒé‚€è¯·äºº</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem; color: #ffc107;">ğŸ“Š</div>
            <div class="stat-number">{{ "%.1f"|format((invite_stats.values() | sum / invite_stats.keys() | length) if invite_stats and invite_stats.keys() | length > 0 else 0) }}</div>
            <div class="stat-label">å¹³å‡é‚€è¯·æ•°</div>
        </div>
    </div>
    
    <!-- é‚€è¯·å…³ç³»è¡¨æ ¼ -->
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>é‚€è¯·äºº</th>
                    <th>è¢«é‚€è¯·äºº</th>
                    <th>é‚€è¯·ç </th>
                    <th>é‚€è¯·æ—¶é—´</th>
                    <th>æ¿€æ´»çŠ¶æ€</th>
                    <th>å¥–åŠ±çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for user in invited_users.items %}
                <tr>
                    <td>
                        <div style="font-weight: 600;">{{ user.invited_by }}</div>
                        <div style="font-size: 0.8rem; color: #666;">é‚€è¯·äºº</div>
                    </td>
                    <td>
                        <div style="font-weight: 600;">{{ user.username }}</div>
                        <div style="font-size: 0.8rem; color: #666;">{{ user.email }}</div>
                    </td>
                    <td>
                        <div class="invite-code">{{ user.invite_code_used or '-' }}</div>
                    </td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
                    <td>
                        {% if user.is_active %}
                            <span class="invite-status status-unused">å·²æ¿€æ´»</span>
                        {% else %}
                            <span class="invite-status status-expired">æœªæ¿€æ´»</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.invite_activated_at %}
                            <span class="invite-status status-used">å·²å‘æ”¾</span>
                        {% else %}
                            <span class="invite-status status-expired">æœªå‘æ”¾</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" onclick="viewUserDetail({{ user.id }})">è¯¦æƒ…</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if not invited_users.items %}
    <div style="text-align: center; padding: 3rem; color: #666;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">ğŸ¤</div>
        <p>æš‚æ— é‚€è¯·å…³ç³»è®°å½•</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem;">ç”¨æˆ·ä½¿ç”¨é‚€è¯·ç æ³¨å†Œåå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
    </div>
    {% endif %}
</div>

<!-- é‚€è¯·è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="inviteDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 20px; width: 90%; max-width: 600px;">
        <h3 style="margin-bottom: 1.5rem;">é‚€è¯·è¯¦æƒ…</h3>
        <div id="inviteDetailContent">
            <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
        </div>
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn btn-danger" onclick="hideInviteDetailModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script>
function viewInviteDetail(inviteId) {
    fetch(`/admin/user_invites/${inviteId}/detail`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const detail = data.detail;
                document.getElementById('inviteDetailContent').innerHTML = `
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(102, 126, 234, 0.05); padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: #667eea;">é‚€è¯·äººä¿¡æ¯</h4>
                            <p><strong>ç”¨æˆ·åï¼š</strong>${detail.inviter_username}</p>
                            <p><strong>é‚®ç®±ï¼š</strong>${detail.inviter_email}</p>
                            <p><strong>æ³¨å†Œæ—¶é—´ï¼š</strong>${detail.inviter_created_at}</p>
                        </div>
                        
                        <div style="background: rgba(40, 167, 69, 0.05); padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: #28a745;">è¢«é‚€è¯·äººä¿¡æ¯</h4>
                            <p><strong>ç”¨æˆ·åï¼š</strong>${detail.invitee_username}</p>
                            <p><strong>é‚®ç®±ï¼š</strong>${detail.invitee_email}</p>
                            <p><strong>æ³¨å†Œæ—¶é—´ï¼š</strong>${detail.invitee_created_at}</p>
                            <p><strong>æ¿€æ´»çŠ¶æ€ï¼š</strong>${detail.is_activated ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}</p>
                        </div>
                        
                        <div style="background: rgba(255, 193, 7, 0.05); padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: #ffc107;">é‚€è¯·ä¿¡æ¯</h4>
                            <p><strong>é‚€è¯·ç ï¼š</strong>${detail.invite_code}</p>
                            <p><strong>é‚€è¯·æ—¶é—´ï¼š</strong>${detail.invite_time}</p>
                            <p><strong>å¥–åŠ±çŠ¶æ€ï¼š</strong>${detail.reward_given ? 'å·²å‘æ”¾' : 'æœªå‘æ”¾'}</p>
                        </div>
                    </div>
                `;
                document.getElementById('inviteDetailModal').style.display = 'block';
            } else {
                alert('è·å–è¯¦æƒ…å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('è·å–è¯¦æƒ…å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
        });
}

function hideInviteDetailModal() {
    document.getElementById('inviteDetailModal').style.display = 'none';
}

function giveReward(inviteId) {
    if (confirm('ç¡®å®šè¦ä¸ºæ­¤é‚€è¯·å…³ç³»å‘æ”¾å¥–åŠ±å—ï¼Ÿ')) {
        fetch(`/admin/user_invites/${inviteId}/give_reward`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('å¥–åŠ±å‘æ”¾æˆåŠŸï¼', 'success');
                location.reload();
            } else {
                alert('å¥–åŠ±å‘æ”¾å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('å¥–åŠ±å‘æ”¾å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
        });
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 9999;
        font-size: 0.9rem;
        max-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentElement) {
                toast.parentElement.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// æ·»åŠ åŠ¨ç”»æ ·å¼
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}