{% extends "admin/base.html" %}

{% block page_title %}邀请关系管理{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">🤝 邀请关系管理</h2>
    </div>
    
    <!-- 统计信息 -->
    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem;">
        <div class="stat-card">
            <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem; color: #667eea;">🎫</div>
            <div class="stat-number">{{ stats.total_invites }}</div>
            <div class="stat-label">总邀请数</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem; color: #28a745;">✅</div>
            <div class="stat-number">{{ stats.successful_invites }}</div>
            <div class="stat-label">成功邀请</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem; color: #17a2b8;">👥</div>
            <div class="stat-number">{{ stats.active_inviters }}</div>
            <div class="stat-label">活跃邀请人</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem; color: #ffc107;">📊</div>
            <div class="stat-number">{{ "%.1f"|format(stats.avg_invites_per_user) }}</div>
            <div class="stat-label">平均邀请数</div>
        </div>
    </div>
    
    <!-- 邀请关系表格 -->
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>邀请人</th>
                    <th>被邀请人</th>
                    <th>邀请码</th>
                    <th>邀请时间</th>
                    <th>激活状态</th>
                    <th>奖励状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for invite in invites %}
                <tr>
                    <td>
                        <div style="font-weight: 600;">{{ invite.inviter_username }}</div>
                        <div style="font-size: 0.8rem; color: #666;">{{ invite.inviter_email }}</div>
                    </td>
                    <td>
                        <div style="font-weight: 600;">{{ invite.invitee_username }}</div>
                        <div style="font-size: 0.8rem; color: #666;">{{ invite.invitee_email }}</div>
                    </td>
                    <td>
                        <div class="invite-code">{{ invite.invite_code }}</div>
                    </td>
                    <td>{{ invite.invite_time.strftime('%Y-%m-%d %H:%M') if invite.invite_time else '-' }}</td>
                    <td>
                        {% if invite.is_activated %}
                            <span class="invite-status status-unused">已激活</span>
                        {% else %}
                            <span class="invite-status status-expired">未激活</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if invite.reward_given %}
                            <span class="invite-status status-used">已发放</span>
                        {% else %}
                            <span class="invite-status status-expired">未发放</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" onclick="viewInviteDetail({{ invite.id }})">详情</button>
                            {% if not invite.reward_given and invite.is_activated %}
                                <button class="btn btn-success btn-sm" onclick="giveReward({{ invite.id }})">发放奖励</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if not invites %}
    <div style="text-align: center; padding: 3rem; color: #666;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">🤝</div>
        <p>暂无邀请关系记录</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem;">用户使用邀请码注册后将在这里显示</p>
    </div>
    {% endif %}
</div>

<!-- 邀请详情模态框 -->
<div id="inviteDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 20px; width: 90%; max-width: 600px;">
        <h3 style="margin-bottom: 1.5rem;">邀请详情</h3>
        <div id="inviteDetailContent">
            <!-- 详情内容将通过JavaScript填充 -->
        </div>
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn btn-danger" onclick="hideInviteDetailModal()">关闭</button>
        </div>
    </div>
</div>

<script>
function viewInviteDetail(inviteId) {
    fetch(`/admin/user_invites/${inviteId}/detail`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const detail = data.detail;
                document.getElementById('inviteDetailContent').innerHTML = `
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(102, 126, 234, 0.05); padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: #667eea;">邀请人信息</h4>
                            <p><strong>用户名：</strong>${detail.inviter_username}</p>
                            <p><strong>邮箱：</strong>${detail.inviter_email}</p>
                            <p><strong>注册时间：</strong>${detail.inviter_created_at}</p>
                        </div>
                        
                        <div style="background: rgba(40, 167, 69, 0.05); padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: #28a745;">被邀请人信息</h4>
                            <p><strong>用户名：</strong>${detail.invitee_username}</p>
                            <p><strong>邮箱：</strong>${detail.invitee_email}</p>
                            <p><strong>注册时间：</strong>${detail.invitee_created_at}</p>
                            <p><strong>激活状态：</strong>${detail.is_activated ? '已激活' : '未激活'}</p>
                        </div>
                        
                        <div style="background: rgba(255, 193, 7, 0.05); padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: #ffc107;">邀请信息</h4>
                            <p><strong>邀请码：</strong>${detail.invite_code}</p>
                            <p><strong>邀请时间：</strong>${detail.invite_time}</p>
                            <p><strong>奖励状态：</strong>${detail.reward_given ? '已发放' : '未发放'}</p>
                        </div>
                    </div>
                `;
                document.getElementById('inviteDetailModal').style.display = 'block';
            } else {
                alert('获取详情失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取详情失败：网络错误');
        });
}

function hideInviteDetailModal() {
    document.getElementById('inviteDetailModal').style.display = 'none';
}

function giveReward(inviteId) {
    if (confirm('确定要为此邀请关系发放奖励吗？')) {
        fetch(`/admin/user_invites/${inviteId}/give_reward`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('奖励发放成功！', 'success');
                location.reload();
            } else {
                alert('奖励发放失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('奖励发放失败：网络错误');
        });
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 9999;
        font-size: 0.9rem;
        max-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentElement) {
                toast.parentElement.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// 添加动画样式
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}