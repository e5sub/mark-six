{% extends "admin/base.html" %}

{% block page_title %}ç”¨æˆ·ç®¡ç†{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ğŸ‘¥ ç®¡ç†ç”¨æˆ·</h2>
        <div style="display: flex; gap: 1rem;">
            <a href="#" class="btn" onclick="showAddUserModal()">+ æ·»åŠ ç”¨æˆ·</a>
        </div>
    </div>
    
    <!-- æœç´¢è¡¨å• -->
    <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 1rem;">
        <form method="GET" action="{{ url_for('admin.users') }}" style="display: flex; gap: 1rem; align-items: center;">
            <div style="flex-grow: 1;">
                <input type="text" name="search" class="form-control" placeholder="æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±..." value="{{ search_query or '' }}">
            </div>
            <div>
                <button type="submit" class="btn">ğŸ” æœç´¢</button>
                {% if search_query %}
                <a href="{{ url_for('admin.users') }}" class="btn btn-danger">æ¸…é™¤</a>
                {% endif %}
            </div>
        </form>
    </div>
    
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>é‚®ç®±</th>
                    <th>çŠ¶æ€</th>
                    <th>ç®¡ç†å‘˜</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th>æœ‰æ•ˆæœŸè‡³</th>
                    <th>é‚€è¯·äºº</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-user-id="{{ user.id }}">
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        {% if user.is_active %}
                            <span class="invite-status status-unused">å·²æ¿€æ´»</span>
                        {% else %}
                            <span class="invite-status status-expired">æœªæ¿€æ´»</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_admin %}
                            <span class="invite-status status-used">æ˜¯</span>
                        {% else %}
                            <span class="invite-status status-unused">å¦</span>
                        {% endif %}
                    </td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
                    <td>
                        {% if user.activation_expires_at %}
                            {{ user.activation_expires_at.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                            <span class="invite-status status-unused">æ°¸ä¹…</span>
                        {% endif %}
                    </td>
                    <td>{{ user.invited_by or '-' }}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            {% if user.is_active %}
                                <button class="btn btn-danger btn-sm" onclick="deactivateUser({{ user.id }})">åœç”¨</button>
                            {% else %}
                                <button class="btn btn-success btn-sm" onclick="activateUser({{ user.id }})">æ¿€æ´»</button>
                            {% endif %}
                            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-primary btn-sm">ç¼–è¾‘</a>
                            <button class="btn btn-warning btn-sm" onclick="resetPassword({{ user.id }})">é‡ç½®å¯†ç </button>
                            {% if not user.is_admin %}
                                <button class="btn btn-danger btn-sm" onclick="deleteUser({{ user.id }})">åˆ é™¤</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
<div id="addUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 20px; width: 90%; max-width: 500px;">
        <h3 style="margin-bottom: 1.5rem;">æ·»åŠ æ–°ç”¨æˆ·</h3>
        <form id="addUserForm">
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" name="username" class="form-control" required>
            </div>
            <div class="form-group">
                <label>é‚®ç®±</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" name="password" class="form-control" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_admin"> ç®¡ç†å‘˜æƒé™
                </label>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-danger" onclick="hideAddUserModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn">æ·»åŠ </button>
            </div>
        </form>
    </div>
</div>

<!-- é‡ç½®å¯†ç æ¨¡æ€æ¡† -->
<div id="resetPasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 20px; width: 90%; max-width: 500px;">
        <h3 style="margin-bottom: 1.5rem;">é‡ç½®å¯†ç </h3>
        <p>æ‚¨æ­£åœ¨ä¸ºç”¨æˆ· <strong id="resetUsername"></strong> é‡ç½®å¯†ç </p>
        <form id="resetPasswordForm">
            <input type="hidden" id="resetUserId" name="user_id">
            <div class="form-group">
                <label>æ–°å¯†ç </label>
                <input type="password" name="new_password" class="form-control" required>
            </div>
            <div class="form-group">
                <label>ç¡®è®¤å¯†ç </label>
                <input type="password" name="confirm_password" class="form-control" required>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-danger" onclick="hideResetPasswordModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¡®è®¤é‡ç½®</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddUserModal() {
    document.getElementById('addUserModal').style.display = 'block';
}

function hideAddUserModal() {
    document.getElementById('addUserModal').style.display = 'none';
}

function showResetPasswordModal(userId, username) {
    document.getElementById('resetUserId').value = userId;
    document.getElementById('resetUsername').textContent = username;
    document.getElementById('resetPasswordModal').style.display = 'block';
}

function hideResetPasswordModal() {
    document.getElementById('resetPasswordModal').style.display = 'none';
}

function resetPassword(userId) {
    // è·å–ç”¨æˆ·å
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    const username = row ? row.querySelector('td:nth-child(2)').textContent.trim() : '';
    showResetPasswordModal(userId, username);
}

function activateUser(userId) {
    if (confirm('ç¡®å®šè¦æ¿€æ´»æ­¤ç”¨æˆ·å—ï¼Ÿ')) {
        fetch(`/admin/users/${userId}/activate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('æ“ä½œå¤±è´¥ï¼š' + data.message);
            }
        });
    }
}

function deactivateUser(userId) {
    // è·å–ç”¨æˆ·å
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    const username = row ? row.querySelector('td:nth-child(2)').textContent.trim() : '';
    
    if (username === 'admin') {
        alert('ä¸èƒ½åœç”¨adminè´¦å·ï¼');
        return;
    }
    
    if (confirm('ç¡®å®šè¦åœç”¨æ­¤ç”¨æˆ·å—ï¼Ÿ')) {
        fetch(`/admin/users/${userId}/deactivate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('æ“ä½œå¤±è´¥ï¼š' + data.message);
            }
        });
    }
}

function deleteUser(userId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        fetch(`/admin/users/${userId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('æ“ä½œå¤±è´¥ï¼š' + data.message);
            }
        });
    }
}

document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        is_admin: formData.get('is_admin') ? true : false
    };
    
    fetch('/admin/users/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('æ·»åŠ å¤±è´¥ï¼š' + data.message);
        }
    });
});

document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const userId = formData.get('user_id');
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        return;
    }
    
    const data = {
        new_password: newPassword
    };
    
    fetch(`/admin/users/${userId}/reset_password`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('å¯†ç é‡ç½®æˆåŠŸ');
            hideResetPasswordModal();
        } else {
            alert('å¯†ç é‡ç½®å¤±è´¥ï¼š' + data.message);
        }
    });
});
</script>

<style>
/* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
.invite-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
}

.status-used {
    background-color: #e3f2fd;
    color: #0d47a1;
}

.status-unused {
    background-color: #e8f5e9;
    color: #1b5e20;
}

.status-expired {
    background-color: #ffebee;
    color: #b71c1c;
}

/* æŒ‰é’®ç»Ÿä¸€æ ·å¼ */
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
    white-space: nowrap;
    min-width: 60px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* æ“ä½œæŒ‰é’®å®¹å™¨æ ·å¼ */
td > div {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}
</style>
{% endblock %}