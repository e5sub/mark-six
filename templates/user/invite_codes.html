{% extends "user/base.html" %}

{% block page_title %}邀请好友{% endblock %}

{% block content %}
<!-- 统计信息 -->
<div class="stats-grid">
    <div class="stat-card-compact">
        <div class="stat-icon" style="color: #667eea;">👥</div>
        <div class="stat-number">{{ stats.total_generated or 0 }}</div>
        <div class="stat-label">总生成数</div>
    </div>
    
    <div class="stat-card-compact">
        <div class="stat-icon" style="color: #28a745;">✅</div>
        <div class="stat-number">{{ stats.total_invites or 0 }}</div>
        <div class="stat-label">已使用</div>
    </div>
    
    <div class="stat-card-compact">
        <div class="stat-icon" style="color: #ffc107;">⏳</div>
        <div class="stat-number">{{ invite_codes|length if invite_codes else 0 }}</div>
        <div class="stat-label">剩余可用</div>
    </div>
    
    <div class="stat-card-compact">
        <div class="stat-icon" style="color: #17a2b8;">🎁</div>
        <div class="stat-number">7天</div>
        <div class="stat-label">奖励天数</div>
    </div>
</div>

<!-- 邀请奖励说明 -->
<div class="card-compact reward-card">
    <div class="card-header-compact">
        <h2 class="card-title-compact">🎁 邀请奖励机制</h2>
    </div>
    
    <div class="reward-content">
        <div class="reward-item">
            <span class="reward-icon">👤</span>
            <div class="reward-text">
                <strong>邀请好友注册</strong>
                <p>每成功邀请一位好友注册，您和好友都将获得额外的有效期奖励</p>
            </div>
        </div>
        
        <div class="reward-item">
            <span class="reward-icon">⏰</span>
            <div class="reward-text">
                <strong>有效期延长</strong>
                <p>根据邀请数量，系统会自动为您的账户延长相应的有效期天数</p>
            </div>
        </div>
        
        <div class="reward-item">
            <span class="reward-icon">🔄</span>
            <div class="reward-text">
                <strong>双向奖励</strong>
                <p>邀请者和被邀请者都能获得奖励，实现互利共赢</p>
            </div>
        </div>
    </div>
</div>

<!-- 生成邀请码 -->
<div class="card-compact">
    <div class="card-header-compact">
        <h2 class="card-title-compact">🔗 生成邀请码</h2>
    </div>
    
    <div class="generate-section">
        <div class="generate-info">
            <div class="info-item">
                <span class="info-icon">📝</span>
                <span class="info-text">每个用户最多可生成 <strong>10个</strong> 邀请码</span>
            </div>
            <div class="info-item">
                <span class="info-icon">⏱️</span>
                <span class="info-text">邀请码永久有效，可重复使用</span>
            </div>
            <div class="info-item">
                <span class="info-icon">🎯</span>
                <span class="info-text">分享给好友，共同享受预测乐趣</span>
            </div>
        </div>
        
        {% set total_codes = invite_codes|length if invite_codes else 0 %}
        {% if total_codes < 10 %}
        <form method="POST" action="{{ url_for('user.generate_invite_code') }}" class="generate-form">
            <button type="submit" class="generate-btn">
                <span class="btn-icon">✨</span>
                <span class="btn-text">生成新的邀请码</span>
            </button>
        </form>
        {% else %}
        <div class="limit-notice">
            <span class="notice-icon">⚠️</span>
            <span class="notice-text">您已达到邀请码生成上限（10个）</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- 我的邀请码 -->
<div class="card-compact">
    <div class="card-header-compact">
        <h2 class="card-title-compact">📋 我的邀请码</h2>
    </div>
    
    {% if invite_codes %}
    <div class="invite-codes-grid">
        {% for code in invite_codes %}
        <div class="invite-code-item {% if code.is_used %}used{% endif %}">
            <div class="code-header">
                <div class="code-status">
                    {% if code.is_used %}
                    <span class="status-badge used">✅ 已使用</span>
                    {% else %}
                    <span class="status-badge available">🔥 可用</span>
                    {% endif %}
                </div>
                <div class="code-date">
                    {{ code.created_at.strftime('%m-%d %H:%M') }}
                </div>
            </div>
            
            <div class="code-content">
                <div class="code-value" onclick="copyToClipboard('{{ code.code }}', this)">
                    <span class="code-text">{{ code.code }}</span>
                    <span class="copy-icon">📋</span>
                </div>
                
                {% if code.is_used and code.used_by_user %}
                <div class="used-info">
                    <span class="used-icon">👤</span>
                    <span class="used-text">被用户 <strong>{{ code.used_by_user.username }}</strong> 使用</span>
                </div>
                {% endif %}
            </div>
            
            <div class="code-actions">
                <button onclick="shareInviteCode('{{ code.code }}')" class="action-btn share-btn">
                    <span class="btn-icon">📤</span>
                    <span class="btn-text">分享</span>
                </button>
                
                <button onclick="copyInviteLink('{{ code.code }}')" class="action-btn copy-btn">
                    <span class="btn-icon">🔗</span>
                    <span class="btn-text">复制链接</span>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">📝</div>
        <h3 class="empty-title">没有可用的邀请码</h3>
        <p class="empty-text">
            {% if stats.total_generated > 0 %}
            您的邀请码已全部使用，可以点击上方按钮生成新的邀请码！
            {% else %}
            点击上方按钮生成您的第一个邀请码吧！
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

<!-- 使用说明 -->
<div class="card-compact">
    <div class="card-header-compact">
        <h2 class="card-title-compact">📖 使用说明</h2>
    </div>
    
    <div class="help-content">
        <div class="help-section">
            <h4 class="help-title">🎯 如何邀请好友</h4>
            <ol class="help-list">
                <li>点击"生成新的邀请码"按钮创建邀请码</li>
                <li>复制邀请码或邀请链接分享给好友</li>
                <li>好友在注册时输入您的邀请码</li>
                <li>注册成功后，双方都将获得奖励</li>
            </ol>
        </div>
        
        <div class="help-section">
            <h4 class="help-title">💡 温馨提示</h4>
            <ul class="help-list">
                <li>每个邀请码可以被多个用户使用</li>
                <li>邀请码永久有效，请妥善保管</li>
                <li>点击邀请码可以快速复制到剪贴板</li>
                <li>分享链接包含完整的注册地址</li>
            </ul>
        </div>
    </div>
</div>

<style>
/* 继承dashboard的基础样式 */
.card-compact {
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
    margin-bottom: 1rem;
    overflow: hidden;
}

.card-header-compact {
    padding: 0.8rem 1.2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.card-title-compact {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.stat-card-compact {
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
    transition: all 0.3s ease;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.stat-card-compact:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 0.3rem;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    font-weight: 500;
}

/* 奖励卡片 */
.reward-card {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
    border-left: 4px solid #28a745;
}

.reward-content {
    padding: 1.2rem;
    display: grid;
    gap: 1rem;
}

.reward-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.reward-item:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateX(5px);
}

.reward-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.reward-text strong {
    color: #28a745;
    font-size: 1.1rem;
    display: block;
    margin-bottom: 0.3rem;
}

.reward-text p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
}

/* 生成区域 */
.generate-section {
    padding: 1.2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
}

.generate-info {
    flex: 1;
    display: grid;
    gap: 0.5rem;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #666;
}

.info-icon {
    font-size: 1.1rem;
}

.generate-form {
    flex-shrink: 0;
}

.generate-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
}

.btn-icon {
    font-size: 1.2rem;
}

.limit-notice {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: white;
    border-radius: 8px;
    font-weight: 600;
}

.notice-icon {
    font-size: 1.2rem;
}

/* 邀请码网格 */
.invite-codes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    padding: 1.2rem;
}

.invite-code-item {
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    border: 2px solid rgba(102, 126, 234, 0.1);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.invite-code-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-color: rgba(102, 126, 234, 0.3);
}

.invite-code-item.used {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-color: rgba(108, 117, 125, 0.2);
}

.invite-code-item.used::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #6c757d 0%, #495057 100%);
}

.invite-code-item:not(.used)::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
}

.status-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-badge.available {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.status-badge.used {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.code-date {
    font-size: 0.8rem;
    color: #666;
}

.code-content {
    margin-bottom: 1rem;
}

.code-value {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0.5rem;
}

.code-value:hover {
    background: rgba(102, 126, 234, 0.2);
    transform: scale(1.02);
}

.code-text {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: 700;
    color: #667eea;
    letter-spacing: 1px;
}

.copy-icon {
    font-size: 1.2rem;
    opacity: 0.7;
    transition: all 0.3s ease;
}

.code-value:hover .copy-icon {
    opacity: 1;
    transform: scale(1.1);
}

.used-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: #666;
    padding: 0.5rem 0.8rem;
    background: rgba(108, 117, 125, 0.1);
    border-radius: 6px;
}

.used-icon {
    font-size: 1rem;
}

.code-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.3rem;
    padding: 0.6rem;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.share-btn {
    background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
    color: white;
}

.copy-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #666;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-title {
    margin: 0 0 0.5rem 0;
    font-size: 1.3rem;
    color: #333;
}

.empty-text {
    margin: 0;
    font-size: 0.9rem;
    line-height: 1.4;
}

/* 帮助内容 */
.help-content {
    padding: 1.2rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.help-section {
    background: rgba(102, 126, 234, 0.05);
    padding: 1rem;
    border-radius: 8px;
    border-left: 3px solid #667eea;
}

.help-title {
    margin: 0 0 0.8rem 0;
    color: #667eea;
    font-size: 1rem;
    font-weight: 600;
}

.help-list {
    margin: 0;
    padding-left: 1.2rem;
    color: #666;
    font-size: 0.9rem;
    line-height: 1.5;
}

.help-list li {
    margin-bottom: 0.3rem;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .generate-section {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .invite-codes-grid {
        grid-template-columns: 1fr;
    }
    
    .help-content {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .code-actions {
        flex-direction: column;
    }
}

/* 复制成功提示 */
.copy-success {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
</style>

<script>
// 复制到剪贴板
function copyToClipboard(text, element) {
    // 使用降级方案，确保在所有浏览器中都能工作
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopySuccess('邀请码已复制到剪贴板');
        
        // 添加复制动画效果
        if (element) {
            element.style.background = 'rgba(40, 167, 69, 0.2)';
            setTimeout(() => {
                element.style.background = 'rgba(102, 126, 234, 0.1)';
            }, 300);
        }
    } catch (err) {
        console.error('复制失败:', err);
        showCopySuccess('复制失败，请手动复制', 'error');
    } finally {
        document.body.removeChild(textArea);
    }
}

// 处理生成邀请码表单提交
document.addEventListener('DOMContentLoaded', function() {
    const generateForm = document.querySelector('.generate-form');
    if (generateForm) {
        generateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            fetch('{{ url_for("user.generate_invite_code") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCopySuccess('邀请码生成成功！');
                    // 刷新页面显示新生成的邀请码
                    window.location.reload();
                } else {
                    showCopySuccess(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showCopySuccess('生成邀请码时出错，请稍后再试', 'error');
            });
        });
    }
});

// 分享邀请码
function shareInviteCode(code) {
    // 使用当前部署的URL作为基础，确保链接可访问
    const baseUrl = window.location.origin;
    const text = `🎯 邀请您加入AI数据分析预测系统！\n\n邀请码：${code}\n\n注册地址：${baseUrl}/register\n\n使用邀请码注册，我们都能获得额外奖励哦！`;
    
    if (navigator.share) {
        navigator.share({
            title: 'AI数据分析预测系统邀请',
            text: text
        }).catch(err => {
            console.error('分享失败:', err);
            copyToClipboard(text);
            showCopySuccess('邀请信息已复制到剪贴板');
        });
    } else {
        copyToClipboard(text);
        showCopySuccess('邀请信息已复制到剪贴板');
    }
}

// 复制邀请链接
function copyInviteLink(code) {
    // 使用当前部署的URL作为基础，确保链接可访问
    const baseUrl = window.location.origin;
    const link = `${baseUrl}/register?invite_code=${code}`;
    copyToClipboard(link, null);
    showCopySuccess('邀请链接已复制到剪贴板');
}

// 显示复制成功提示
function showCopySuccess(message, type = 'success') {
    // 移除已存在的提示
    const existing = document.querySelector('.copy-success');
    if (existing) {
        existing.remove();
    }
    
    // 创建新提示
    const toast = document.createElement('div');
    toast.className = 'copy-success';
    
    if (type === 'error') {
        toast.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
    }
    
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.2rem;">${type === 'success' ? '✅' : '❌'}</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // 3秒后自动移除
    setTimeout(() => {
        toast.style.animation = 'slideInRight 0.3s ease-out reverse';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}
</script>
{% endblock %}