name: Android Release APK

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
    paths:
      - 'mobile/mark_six/**'
      - '.github/workflows/android-release.yml'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Write local.properties
        run: |
          FLUTTER_SDK=$(dirname "$(dirname "$(which flutter)")")
          VERSION_NAME=$(python - <<'PY'
          import os
          ref = os.environ.get("GITHUB_REF", "")
          tag = ref.rsplit("/", 1)[-1] if ref else ""
          if tag.startswith("v"):
              print(tag[1:])
          else:
              run = int(os.environ.get("GITHUB_RUN_NUMBER", "1"))
              base = 1.0
              version = base + (run - 1) / 10.0
              print(f"{version:.1f}")
          PY
          )
          VERSION_CODE=${GITHUB_RUN_NUMBER}
          echo "flutter.sdk=$FLUTTER_SDK" > android/local.properties
          echo "flutter.versionCode=$VERSION_CODE" >> android/local.properties
          echo "flutter.versionName=$VERSION_NAME" >> android/local.properties
        working-directory: mobile/mark_six

      - name: Sync pubspec version
        run: |
          VERSION_NAME=$(python - <<'PY'
          import os
          ref = os.environ.get("GITHUB_REF", "")
          tag = ref.rsplit("/", 1)[-1] if ref else ""
          if tag.startswith("v"):
              print(tag[1:])
          else:
              run = int(os.environ.get("GITHUB_RUN_NUMBER", "1"))
              base = 1.0
              version = base + (run - 1) / 10.0
              print(f"{version:.1f}")
          PY
          )
          VERSION_CODE=${GITHUB_RUN_NUMBER}
          python - <<PY
          from pathlib import Path
          version_name = "${VERSION_NAME}"
          version_code = "${VERSION_CODE}"
          pubspec = Path("pubspec.yaml")
          lines = pubspec.read_text(encoding="utf-8").splitlines()
          out = []
          replaced = False
          for line in lines:
              if line.startswith("version:"):
                  out.append(f"version: {version_name}+{version_code}")
                  replaced = True
              else:
                  out.append(line)
          if not replaced:
              out.insert(1, f"version: {version_name}+{version_code}")
          pubspec.write_text("\n".join(out) + "\n", encoding="utf-8")
          PY
        working-directory: mobile/mark_six

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/caiya_release.jks
          cat > android/key.properties <<EOF
          storeFile=caiya_release.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF
        working-directory: mobile/mark_six

      - name: Remove legacy Gradle files
        run: |
          rm -f android/app/build.gradle
          rm -f android/build.gradle
          rm -f android/settings.gradle
          rm -rf android/app/src/main/kotlin
        working-directory: mobile/mark_six

      - name: Flutter pub get
        run: flutter pub get
        working-directory: mobile/mark_six

      - name: Build release APK
        run: flutter build apk --release
        working-directory: mobile/mark_six

      - name: Read version
        id: app_version
        run: |
          VERSION_NAME=$(python - <<'PY'
          import os
          ref = os.environ.get("GITHUB_REF", "")
          tag = ref.rsplit("/", 1)[-1] if ref else ""
          if tag.startswith("v"):
              print(tag[1:])
          else:
              run = int(os.environ.get("GITHUB_RUN_NUMBER", "1"))
              base = 1.0
              version = base + (run - 1) / 10.0
              print(f"{version:.1f}")
          PY
          )
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION_NAME" >> $GITHUB_OUTPUT
        working-directory: mobile/mark_six

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: mark-six-release-apk
          path: mobile/mark_six/build/app/outputs/flutter-apk/app-release.apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.app_version.outputs.tag }}
          name: ${{ steps.app_version.outputs.version_name }}
          generate_release_notes: true
          files: mobile/mark_six/build/app/outputs/flutter-apk/app-release.apk
